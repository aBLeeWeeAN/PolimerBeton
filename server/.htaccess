<VirtualHost *:80>
    ServerAdmin Polimerbeton-vrn@yandex.ru
    ServerName polimerbeton-vrn.ru
    ServerAlias www.polimerbeton-vrn.ru

    DocumentRoot /www/PolimerBeton
    
    # Настройка редиректа с HTTP на HTTPS
    RewriteEngine on
    RewriteCond %{SERVER_PORT} !^443$
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]   

    #RewriteCond %{SERVER_NAME} =polimerbeton-vrn.ru [OR]
    #RewriteCond %{SERVER_NAME} =www.polimerbeton-vrn.ru
    #RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]

    # Настройка редиректа с HTTP на HTTPS
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Логирование ошибок и запросов (опционально)
    ErrorLog ${APACHE_LOG_DIR}/django-polimerbeton-error.log
    CustomLog ${APACHE_LOG_DIR}/django-polimerbeton-access.log combined
</VirtualHost>

<IfModule mod_ssl.c>
SSLStaplingCache shmcb:/var/run/apache2/stapling_cache(128000)

<VirtualHost *:443>
    ServerAdmin Polimerbeton-vrn@yandex.ru
    ServerName polimerbeton-vrn.ru
    ServerAlias www.polimerbeton-vrn.ru

    DocumentRoot /www/PolimerBeton

    # Путь к статическим файлам
    Alias /static/ /www/PolimerBeton/static_files/

    <Directory /www/PolimerBeton/static_files>
        Require all granted
    </Directory>
    
    <Directory /www/PolimerBeton/config>
        <Files wsgi.py>
            Require all granted
        </Files>
    </Directory>

    # Путь к медиафайлам (если есть)
    # Alias /media/ /path/to/your/project/media
    # <Directory /path/to/your/project/media>
        # Require all granted
    # </Directory>

    # Настройка WSGI для Django
    #WSGIDaemonProcess main_app python-home=/www/PolimerBeton/venv python-path=/www/PolimerBeton
    WSGIDaemonProcess main_app python-path=/www/PolimerBeton:/www/PolimerBeton/venv/lib/python3.12/site-packages

    WSGIProcessGroup main_app
    WSGIScriptAlias / /www/PolimerBeton/config/wsgi.py

    # Сжатие
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/x-component
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/x-httpd-php
        AddOutputFilterByType DEFLATE application/x-httpd-fastphp
        AddOutputFilterByType DEFLATE application/json
            
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        Header append Vary User-Agent
    </IfModule>

    # <Directory /www/PolimerBeton>
    #     <Files wsgi.py>
    #         Require all granted
    #     </Files>
    # </Directory>

    ErrorLog ${APACHE_LOG_DIR}/django-polimerbeton-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/django-polimerbeton-ssl-access.log combined

    # SSL настройки
    SSLEngine on

    # Let's Encrypt SSL сертификаты
    SSLCertificateFile /etc/letsencrypt/live/polimerbeton-vrn.ru-0001/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/polimerbeton-vrn.ru-0001/privkey.pem

    # Ensure that Django runs with a secure proxy
    RequestHeader set X-Forwarded-Proto "https"

    # Enable HTTP/2
    Protocols h2 http/1.1

    # Дополнительные настройки безопасности
    Include /etc/letsencrypt/options-ssl-apache.conf
    Header always set Strict-Transport-Security "max-age=31536000"
    SSLUseStapling on

</VirtualHost>

</IfModule>